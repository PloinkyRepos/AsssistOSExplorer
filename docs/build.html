<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOPLang Build - Explorer Agent</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-top">
                    <a href="index.html" class="logo">
                        <div class="logo-icon">ðŸš€</div>
                        <span>Explorer Agent</span>
                    </a>
                    <button class="theme-toggle" id="themeToggle">ðŸŒ™</button>
                </div>
                <nav>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="architecture.html">Architecture</a></li>
                        <li><a href="documents.html">Document Model &amp; Editing</a></li>
                        <li><a href="plugins.html">Plugins</a></li>
                        <li><a href="mcp-tools.html">MCP Tools</a></li>
                        <li><a href="build.html" class="active">SOPLang Build</a></li>
                        <li><a href="screenshots.html">Screenshots</a></li>
                        <li><a href="development.html">Development</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="doc-layout">
            <aside class="sidebar">
                <h3>SOPLang Build</h3>
                <ul>
                    <li><a href="#overview">Overview</a></li>
                    <li><a href="#build-from-markdown">Building from Markdown</a></li>
                    <li><a href="#soplang-agent-interaction">SOPLang Agent Interaction</a></li>
                </ul>
            </aside>
            <div class="content-wrapper">
                <div class="doc-section" id="overview">
                    <h1>SOPLang Build (Markdown â†’ Documents)</h1>
                    <p>Use <code>SoplangBuilder.buildFromMarkdown</code> (served by <code>soplangAgent</code>) to scan Markdown files and synchronize structured documents into the SOPLang workspace. Explorer remains the UI; the build pipeline itself runs in the separate soplangAgent container.</p>
                </div>

                <div class="doc-section" id="build-from-markdown">
                    <h2>Building from Markdown</h2>
                    <p>The core of the build process for documents originates from Markdown files. The <code>SoplangBuilder</code> plugin, specifically its <code>buildFromMarkdown</code> method, is responsible for this operation.</p>
                    
                    <h3>Workflow Steps:</h3>
                    <ol>
                        <li>
                            <strong>Workspace Root Detection:</strong> The <code>pickRoot()</code> function identifies the root directory of the current workspace, checking environment variables and common parent directories.
                        </li>
                        <li>
                            <strong>Markdown File Discovery:</strong> The <code>walkMarkdown(root)</code> function recursively traverses the detected workspace root to find all <code>.md</code> files. It intelligently skips common development and build directories (e.g., <code>node_modules</code>, <code>.git</code>, <code>.ploinky</code>, <code>dist</code>) to focus on relevant content.
                        </li>
                        <li>
                            <strong>Structured Document Parsing:</strong> For each discovered Markdown file, <code>parseDocsFromMarkdown(content, filePath)</code> extracts structured metadata. This function looks for special HTML-like comments embedded directly within the Markdown content. These comments define the document's structure, including documents, chapters, and paragraphs, along with their associated metadata and SOPLang commands.
                            <h4>Example Markdown Comments:</h4>
                            <pre><code>&lt;!--{"achiles-ide-document": {"id": "my-document", "title": "My Awesome Document", "commands": "doc-level-command"}}--&gt;
# My Document Title

&lt;!--{"achiles-ide-chapter": {"title": "Introduction", "commands": "chapter-level-command"}}--&gt;
## Introduction

This is an introductory paragraph.

&lt;!--{"achiles-ide-paragraph": {"text": "This is a special paragraph.", "commands": "@media_image_123 attach id \"some-blob-id\" name \"my-image.png\""}}--&gt;
This paragraph might have embedded commands.
</code></pre>
                        </li>
                        <li>
                            <strong>Document Store Synchronization:</strong> The extracted document structures are then used to create or update entries in the IDE's internal document store. This involves interacting with the <code>Documents</code> SOPLang plugin to ensure data consistency.
                        </li>
                        <li>
                            <strong>Finalization:</strong> After processing all Markdown files, <code>workspace.forceSave()</code> persists any changes, and <code>workspace.buildAll()</code> triggers a comprehensive build of the entire workspace, integrating all updates.
                        </li>
                    </ol>
                </div>

                <div class="doc-section" id="soplang-agent-interaction">
                    <h2>SOPLang Agent Interaction</h2>
                    <p>The <code>buildFromMarkdown</code> function is invoked through the <code>soplangAgent</code> (repo <code>SOPLangBuilder</code>) using its MCP tool <code>soplang-tool</code> defined in <code>soplangAgent/mcp-config.json</code>. Payload fields: <code>pluginName</code> (string), <code>methodName</code> (string), <code>params</code> (array, optional).</p>
                    <p>Setup steps from workspace root:</p>
                    <ol>
                        <li><code>p-cli enable repo SOPLangBuilder</code></li>
                        <li><code>p-cli enable agent SOPLangBuilder/soplangAgent global</code></li>
                        <li>Start the agent per Ploinky CLI (e.g., <code>p-cli start soplangAgent</code> if not already running).</li>
                        <li>Call MCP tool <code>soplang-tool</code> with <code>pluginName: "SoplangBuilder"</code> and <code>methodName: "buildFromMarkdown"</code> (add <code>params</code> array if needed). Results and plugin console output are written to <code>SOPLangBuilder/last-tool.log</code>; persistence/log/audit paths are set in <code>soplangAgent/soplang-tool.sh</code>.</li>
                    </ol>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Ploinky Project. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        const themes = ['light', 'dark', 'blue'];
        const themeIcons = {
            light: 'ðŸŒ™', // Icon to show for switching to dark
            dark: 'ðŸ”µ',  // Icon to show for switching to blue
            blue: 'â˜€ï¸'   // Icon to show for switching to light
        };

        const applyTheme = (theme) => {
            body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeToggle.textContent = themeIcons[theme];
        };
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            applyTheme(newTheme);
        });

        // Highlight active section in sidebar
        const sections = document.querySelectorAll('.doc-section[id]');
        const navLinks = document.querySelectorAll('.sidebar a');
        
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
